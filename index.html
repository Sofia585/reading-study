<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>閱讀任務</title>
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
    #article { white-space: pre-wrap; max-width: 800px; margin: auto; }
    #end-message { font-weight: bold; color: red; margin-top: 40px; display: none; }
  </style>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>閱讀任務</h1>
  <div id="article">載入中...</div>
  <div id="end-message">請回到問卷中繼續回答問題。</div>

  <script>
    // ✅ 請在這裡貼上你的 Firebase 設定
  const firebaseConfig = {
  apiKey: "AIzaSyBJGP_5OZMH2LP2XFKQgsQXUCQD0yFP7-g",
  authDomain: "read-this-35ecd.firebaseapp.com",
  projectId: "read-this-35ecd",
  storageBucket: "read-this-35ecd.appspot.com",
  messagingSenderId: "263716584195",
  appId: "1:263716584195:web:70d5d3dca0b696fc030736"
};
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ✅ 三篇文章內容
    const articles = {
      "武俠": `"+ article_js_strings['武俠'] +"`,
      "歷史": `"+ article_js_strings['歷史'] +"`,
      "懸疑": `"+ article_js_strings['懸疑'] +"`
    };

    let user = null;
    let docRef = null;
    let focusTimestamps = [];

    function logFocusChange(type) {
      focusTimestamps.push({ type, time: new Date().toISOString() });
      if (docRef) docRef.update({ focusEvents: focusTimestamps });
    }

    window.addEventListener('blur', () => logFocusChange("blur"));
    window.addEventListener('focus', () => logFocusChange("focus"));

    auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
      .then(result => {
        user = result.user;
        const keys = Object.keys(articles);
        const chosenKey = keys[Math.floor(Math.random() * keys.length)];
        document.getElementById("article").textContent = articles[chosenKey];

        const sessionId = Date.now().toString();
        docRef = db.collection("readingSessions").doc(user.uid + "_" + sessionId);
        docRef.set({
          uid: user.uid,
          email: user.email,
          displayName: user.displayName,
          article: chosenKey,
          startedAt: new Date().toISOString(),
          focusEvents: []
        });

        window.addEventListener("beforeunload", () => {
          if (docRef) docRef.update({ endedAt: new Date().toISOString() });
        });

        setTimeout(() => {
          document.getElementById("end-message").style.display = "block";
        }, 3000);
      })
      .catch(err => {
        document.getElementById("article").textContent = "登入失敗：" + err.message;
      });
  </script>
</body>
</html>
      .catch(err => {
        document.getElementById("article").textContent = "登入失敗：" + err.message;
      });
  </script>
</body>
</html>
